SCRIPT_DIRECTORY:=$(abspath $(dir $(lastword $(MAKEFILE_LIST))))
SBATCH_JOB_SCRIPT:=$(SCRIPT_DIRECTORY)/../bin/wrapper_jobscript.sbatch
include $(SCRIPT_DIRECTORY)/parameters.mk
include $(SCRIPT_DIRECTORY)/../lib/scheduler.mk

PROJECT:=b2010008

# standard options for sbatch, mkdir for output file of slurm in case it
# doesn't exist
SBATCH_STD_OPT=-A $(PROJECT) --output=$@-slurm-%j.out -J $@ $(shell mkdir -p $(@D))

################################
# ----- general rules -------- #
################################
%.fastq.gz: %.fastq
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 1-00:00:00 -p core,make -e $@)
################################
# ---- /general rules -------- #
################################

################################
# ------ quality trim -------- #
################################
$(FASTQ_TRIM_IL): $(FASTQ1) $(FASTQ2)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 06:00:00 -p core,make -e $@)
################################
# ------ /quality trim ------- #
################################

################################
# ---------- velveth --------- #
################################
$(VELVETH_OUT)/velveth_$(KMIN)/Sequences: $(FASTQ_TRIM_IL)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
$(VELVETH_OUT)/velveth_%/Roadmaps: $(VELVETH_OUT)/velveth_$(KMIN)/Sequences
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
################################
# --------- /velveth --------- #
################################

################################
# --------- velvetg ---------- #
################################
$(VELVET_OUT_NOSCAF)/noscaf_%/$(CONTIG_FILENAME): $(VELVETH_OUT)/velveth_%/Roadmaps
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 02:00:00 -p node,make -e $@)
$(VELVET_OUT_SCAF)/scaf_%/$(SCAF_FILENAME): $(VELVETH_OUT)/velveth_%/Roadmaps
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 02:00:00 -p node,make -e $@)
################################
# --------- /velvetg --------- #
################################

################################
# ------- meta-velvetg ------- #
################################
$(METAVELVET_OUT_NOSCAF)/noscaf_%/$(CONTIG_FILENAME): $(VELVETH_OUT)/velveth_%/Roadmaps
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 02:00:00 -p node,make -e $@)
$(METAVELVET_OUT_SCAF)/scaf_%/$(SCAF_FILENAME): $(VELVETH_OUT)/velveth_%/Roadmaps
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 02:00:00 -p node,make -e $@)
################################
# ------- /meta-velvetg ------ #
################################

################################
# --------- minimus2  -------- #
################################
$(MINIMUS2_OUT_VELVET_NOSCAF)/$(MERGE_FILENAME): $(VELVETG_OUT_NOSCAF)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
$(MINIMUS2_OUT_METAVELVET_NOSCAF)/$(MERGE_FILENAME): $(METAVELVETG_OUT_NOSCAF)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
$(MINIMUS2_OUT_RAY_NOSCAF)/$(MERGE_FILENAME): $(RAY_CONTIGS_OUT)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
################################
# --------- /minimus2  ------- #
################################

################################
# --------- newbler -----------#
################################
$(NEWBLER_OUT_VELVET_NOSCAF)/$(MERGE_FILENAME): $(VELVETG_OUT_NOSCAF)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
$(NEWBLER_OUT_METAVELVET_NOSCAF)/$(MERGE_FILENAME): $(METAVELVETG_OUT_NOSCAF)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
$(NEWBLER_OUT_RAY_NOSCAF)/$(MERGE_FILENAME): $(RAY_CONTIGS_OUT)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
################################
# -------- /newbler -----------#
################################

################################
# --------- bambus2 -----------#
################################
%/bambus2/bambus2.scaffold.linear.fasta: %/$(MERGE_FILENAME)
%/bambus2/bambus2.scaffold.linear.fasta: %/$(CONTIG_FILENAME)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
################################
# -------- /bambus2 -----------#
################################

################################
# ----------- ray -------------#
################################
$(RAY_OUT)/noscaf/noscaf_%/$(CONTIG_FILENAME): $(FASTQ_TRIM_IL)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 01-00:00:00 -p node,make -e $@)
$(RAY_OUT)/scaf/scaf_%/$(SCAF_FILENAME): $(RAY_OUT)/noscaf/noscaf_%/$(CONTIG_FILENAME)
	$(call schedule_with_deps_and_store_id,$(SBATCH_STD_OPT) -t 00:05:00 --qos=short -p core,make -e $@)
################################
# ---------- /ray -------------#
################################
